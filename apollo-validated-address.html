<!doctype html>

<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/iron-validator-behavior/iron-validator-behavior.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="/bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="apollo-address-validator.html">
<link rel="import" href="apollo-countries-dropdown.html">



<!--
`apollo-validated-address`
Polymer component that validates the entered address

@demo demo/index.html
-->
<style>
    .address-card {
        border: 1px;
        border-style: solid;
    }
</style>
<dom-module id="apollo-validated-address" id="Address">
    <template>

        <apollo-address-validator></apollo-address-validator>

        <paper-autocomplete label="Select User" id="input-remote" remote-source="true" min-length="3" remote-source="true">

            <template autocomplete-custom-template>
            <div class="address-card">
                <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                    <div>
                        <div>[[item.suggest]]</div>
                    </div>
                    <paper-ripple></paper-ripple>
                </paper-item>
                </div>
            </template>
        </paper-autocomplete>

        <paper-input id="addressLine1" name="addressLine1" label="Address Line1" value="{{addressLine1}}"></paper-input>

        <paper-input id="addressLine2" name="addressLine2" label="Address Line2" class="reg" value="{{addressLine2}}"></paper-input>

        <paper-input id="city" name="city" label="Town / City" class="reg" value="{{city}}"></paper-input>

        <paper-input id="state" name="state" label="County" class="reg" value="{{state}}"></paper-input>

        <paper-input id="postalCode" name="postalCode" label="Postal Code" class="reg" value="{{postalCode}}"></paper-input>

        <apollo-countries-dropdown selection={{countrySelection}}></apollo-countries-dropdown>

        <iron-ajax id="addressService" url="http://127.0.0.1:8082/api/address/list" handle-as="json" on-response="_searchResponse" debounce-duration="300" method="POST" content-type="application/json" body="{{query}}"></iron-ajax>

    </template>
    <script>
    Polymer({
        is: "apollo-validated-address",

        properties: {

            searched: {
                type: String,
                observer: '_searchChanged'
            },
            addressLine1: {
                type: String,
                notify: true
            },
            addressLine2: {
                type: String
            },
            city: {
                type: String
            },
            state: {
                type: String
            },
            postalCode: {
                type: String
            },
            countrySelection: {
                type: String
            },
            foundAddress: {
                type: Array,
                notify: true
            },
            query: {
                type: String,
                notify: false,
                reflectToAttribute: false
            }
        },

        listeners: {
            'autocomplete-change': '_searchChanged',
            'autocomplete-selected': '_searchSelected'
        },

        _searchChanged: function(event) {
            console.log("onSearchChanged");
            console.log(event);

            var obj = {
                addressLine1: event.detail.text
            };

            this.query = JSON.stringify(obj);
            console.log(this.query);

            var service = document.querySelector('#addressService');
            service.generateRequest();
        },

        _searchResponse: function(e, res) {
            console.log("response ->" + res.parseResponse());
            this.foundAddress = res.parseResponse();
            document.querySelector('#input-remote').suggestions(this.foundAddress);
        },

        _searchSelected: function(event) {
            var item = event.detail.option;
            console.log("selected -> " + event.detail.option.city);

            this.addressLine1 = item.addressLine1;
            this.addressLine2 = item.addressLine2;
            this.city = item.city;
            this.state = item.state;
        }

    });
    </script>
</dom-module>
