<!doctype html>

<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-styles/color.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/iron-validator-behavior/iron-validator-behavior.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="/bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="apollo-address-validator.html">
<link rel="import" href="apollo-countries-dropdown.html">

<!--
`apollo-validated-address`
Polymer component that validates the entered address

@demo demo/index.html
-->

<dom-module id="apollo-validated-address" id="Address">
    <template>
        <style>
        .selection-card {
            margin-bottom: .5em;
            width: 100%;
        }
        
        .address-card {
            max-width: 500px;
            width: 100%;
        }
        
        :root {
            --primary-color: var(--paper-grey-200);
            --accent-color: var(--paper-blue-500);
            --paper-card-header-color: var(--primary-color);
            --paper-card-header: {
                background-color: var(--accent-color);
                text-align: center;
            }
            .address-card {
                background: --primary-color;
            }
        }
        </style>
        <apollo-address-validator></apollo-address-validator>

        <paper-card class="address-card" heading="Apoll Address Validation">

            <div class="card-content">

                <apollo-countries-dropdown selection={{countrySelection}} id="apollo-countries"></apollo-countries-dropdown>

                <paper-autocomplete label="Address Search" id="input-remote" remote-source="true" min-length="3" remote-source="true">
                    <template autocomplete-custom-template>
                        <paper-card class="selection-card">
                            <div class="card-content">
                                <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                                    <div>
                                        <div>[[item.suggest]]</div>
                                    </div>
                                    <paper-ripple></paper-ripple>
                                </paper-item>
                            </div>
                        </paper-card>
                    </template>
                </paper-autocomplete>

                <paper-input id="addressLine1" name="addressLine1" label="Address Line1" value="{{addressLine1}}"></paper-input>

                <paper-input id="addressLine2" name="addressLine2" label="Address Line2" class="reg" value="{{addressLine2}}"></paper-input>

                <paper-input id="city" name="city" label="Town / City" class="reg" value="{{city}}"></paper-input>

                <paper-input id="postalCode" name="postalCode" label="Postal Code" class="reg" value="{{postalCode}}"></paper-input>
            </div>
        </paper-card>

        <iron-ajax id="addressService" url="http://127.0.0.1:8082/api/address/list" handle-as="json" on-response="_searchResponse" debounce-duration="300" method="POST" content-type="application/json" body="{{query}}"></iron-ajax>

        <iron-ajax id="addressFormatService" url="http://127.0.0.1:8082/api/address/id/[[selectedId]]" handle-as="json" on-response="_addressFormatResponse" debounce-duration="300" method="GET" content-type="application/json"></iron-ajax>

    </template>
    <script>
    Polymer({
        is: "apollo-validated-address",

        properties: {

            /**
            * The input of Address Line 1
            */
            addressLine1: {
                type: String
            },
             /**
            * The input of Address Line 2
            */
            addressLine2: {
                type: String
            },
             /**
            * The input of Address City
            */
            city: {
                type: String
            },
            /**
            * The input of Address Postal Code
            */
            postalCode: {
                type: String
            },
            /**
            * The selected country (default GBR)
            */
            countrySelection: {
                type: String,
                value: 'GBR'
            },
            /**
            * The array of found address returned from
            * search api
            */
            foundAddress: {
                type: Array,
                notify: true
            },
            /**
            * The guid of the address that was selected
            * from teh auto-complete input which will be
            * used to retreive the address details
            */
            selectedId: {
                type: String
            },
            /*
            * The query for the address auto-complete
            * suggestion lookup
            */
            query: {
                type: String,
                notify: false,
                reflectToAttribute: false
            }
        },

        listeners: {
            'autocomplete-change': '_searchChanged',
            'autocomplete-selected': '_searchSelected'
        },

        /**
        * A listener callback when the search input
        * recieves text and should be called on 
        * each keystroke there after
        */
        _searchChanged: function(event) {
            var obj = {
                suggestionQuery: event.detail.text
            };
            this.query = JSON.stringify(obj);

            var service = document.querySelector('#addressService');
            service.generateRequest();
        },

        /**
        * Side effect callback that receives suggestions
        * based on the input query 
        */
        _searchResponse: function(e, res) {
            this.foundAddress = res.parseResponse();
            document.querySelector('#input-remote').suggestions(this.foundAddress);
        },

        /**
        * Listener callback when the suggestion is selected
        * which will capture the suggestion id and 
        * make a detail service call
        */
        _searchSelected: function(event) {
            this.selectedId = event.detail.option.formatId;

            var service = document.querySelector('#addressFormatService');
            service.generateRequest();
        },

        /**
        * The callback for the service address 
        * details which in turn populates
        * the corresponding address fields
        */
        _addressFormatResponse: function(e, res) {
            var obj = res.parseResponse();

            this.addressLine1 = obj.addressLine1;
            this.addressLine2 = obj.addressLine2;
            this.city = obj.town;
            this.postalCode = obj.postCode;
        }

    });
    </script>
</dom-module>
